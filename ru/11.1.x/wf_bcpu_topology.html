	<h1><span>Bhyve топология CPU</span></h1>
	<h2><a name="bcpu_topology_cmd">Команда cpu-topology vm-cpu-topology vm-cpu-topology-tui</a></h2>
	<div class="block">
		<pre class="brush:bash;ruler:true;">
			% cbsd cpu-topology
			% cbsd vm-cpu-topology vm-cpu-topology-tui
			% cbsd vm-cpu-topology-tui
		</pre>
		<p><strong>Описание</strong>:</p>
		<p>Конфигурирование и просмотр топологии CPU виртуальной машины bhyve.</p>
		<br>
		<p>Регулировка топологии CPU виртуальных машин может производится для повышения производительности и оптимизации вычислительных операций, так и в различных задачах, связанных с тестированием.</p>
		<p>При исполнении виртуальных машин важно понимать, что с точки зрения хостера, виртуальные процессоры виртуальной машины являются обычными процессами (в случае с bhyve, отдельный vcpu является тредом в хостер системе).</p>
		<p>Предполагается, что пользователь имеет минимальное представление об устройстве CPU, памяти и NUMA-доменов. Кроме того, для эффективной настройки важно понимать тип деятельности и сервисов ОС конкретного гостя. Наиболее важным является понимание работы L1,L2 и L3 кешей и работа  процессора с определенными блоками памяти.</p>
		<p>Напомним, что L1,L2 кеш - это кеш для одного ядра, тогда как L3 и выше - это кеш на весь процессор (сокет).</p>
		<p>Меняя топологию гостевой операционной системы, вы можете определять различные конфигурации виртуальных процессоров как количество сокетов, количество ядер на сокет и их размещение, а также наличие гипертрединга.</p>
		<p>К примеру, имея 8 ядер, вы можете их сконфигурировать как:</p>
		<ul>
			<li>1 сокет (виртуальный микропроцессор) по 8 ядер, без гипертрединга ( FreeBSD/SMP: <strong>1</strong> package(s) x <strong>8</strong> core(s) )</li>
			<li>1 сокет по 4 ядра, но с гипертредингом ( FreeBSD/SMP: <strong>1</strong> package(s) x <strong>4</strong> core(s) x <strong>2</strong> hardware threads)</li></li>
			<li>2 сокета по 2 ядра и гипертредингом ( FreeBSD/SMP: <strong>2</strong> package(s) x <strong>2</strong> core(s) x <strong>2</strong> hardware threads)</li>
			<li>4 сокета по 2 ядра каждый ( FreeBSD/SMP: <strong>4</strong> package(s) x <strong>2</strong> core(s) )</li>
			<li>и т.д.</li>
		</ul>
		<p>Как таковая конфигурация топологии виртуальной машины никак не сказывается быстродействии самой виртуальной машины:</p>
		<p class="text-center"><img src="/img/cpu_topology_intro.png" alt="" /></p>
		<p>Данные конфигурации становятся важными, совместно с настройками привязывания ядер виртуальной машины к конкретной группе ядер физического сервера ( set_affinity, cpu-pinning ), о чем будет рассказано отдельно. Цель же данной статьи - рассмотреть
		возможности bhyve и работа с его конфигурацией через <strong>CBSD</strong>.</p>
		<p>Для просмотра текущей топологии со стороны хостера, служит команда <strong>cbsd cpu-topology</strong>. Помимо информации о текущей системе, вы сможете увидеть схематическое представление сокетов и ядер, которые обслуживают виртуальные окружения</p>
		<p>Если виртуальная машина привязана к конкретному ядру физической машины, вы увидете ее имя напротив данного ядра определенного сокета. Если привязок нет, напротив каждого ядра будут все виртуальные окружения - поскольку у них нет ограничений на
		использование тех или иных ядер и они могут мигрировать, чем обязаны шедулеру ОС:</p>
		<p class="text-center"><img src="/img/cbsd_cpu_topology1.png" alt="" /></p>
		<p>Сокет - это непосредственно физический процессор (package) на вашей материнской плате. Если процессор поддерживат гипер-трединг (и он включен), виртуальные ядра будут помечены как <em>THR</em></p>
		<p>Вы можете создать любое количество профилей для топологии. Просмотреть их список можно по команде vm-cpu-topology:</p>
		<p class="text-center"><img src="/img/cbsd_cpu_topology3.png" alt="" /></p>
		<p>Удалять или добавлять новые вы можете через TUI интерфейс команды vm-cpu-topology-tui</p>
		<p class="text-center"><img src="/img/cbsd_cpu_topology2.png" alt="" /></p>
		<p>Имена профилей должны быть уникальные и применение той или иной топологии выполняется через команду bset, bconfig. А также, выбор топологий будет доступен при создании виртуальной машины в bconstruct-tui:</p>
		<p class="text-center"><img src="/img/cbsd_cpu_topology4.png" alt="" /></p>
	</div>
